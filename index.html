<!--T8T4f-->
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>LAB 4 Robin och Jonathan</title>

    <script>
        window.addEventListener("load", function() {
            //Fail counters
            let failViewCounter = 0;
            let failAddCounter = 0;
            let failDelCounter = 0;
            let failChangeCounter = 0;
            let btn = document.getElementById("key");

            //Nyckel
            let output = document.getElementById("output")
            let inputKey = document.getElementById("keyin");

            //Lägga till bok
            let ajaxAdd = new XMLHttpRequest(); // NEW AJAX REQUEST
            let addBook = document.getElementById("addBook");
            let title = document.getElementById("title");
            let author = document.getElementById("author");
            let addBookStatus = document.getElementById("addBookStatus");
            //Ändra bok
            let changeBookStatus = document.getElementById("changeBookStatus");
            let changeBook = document.getElementById("changeBook");
            let bookId = document.getElementById("bookId");
            let authorChange = document.getElementById("authorChange");
            let titleChange = document.getElementById("titleChange");
            //Ta bort Book
            let deleteBook = document.getElementById("deleteBook");
            let deleteId = document.getElementById("deleteId");
            let delBookStatus = document.getElementById("delBookStatus");
            //Kolla på böcker
            let viewBooks = document.getElementById("viewBooks");
            let ulList = document.getElementsByTagName("ul");
            let li = document.getElementsByTagName("li");

            let objBooks = ""

            let datum = new Date();
            //Exempel: 2017-11-27 09:58:44 
            let datumet = `${datum.getUTCFullYear()}-${datum.getUTCMonth()+1}-${("0" + datum.getUTCDate()).slice(-2)} ${datum.getUTCHours()+1}:${datum.getUTCMinutes()}:${datum.getUTCSeconds()-1}`;
            console.log(datumet);
            //Datum fix
            //            function checkMin(d) {
            //                if (d < 10)
            //                    return "0" + d;
            //                else
            //                    return d;
            //            };

            //////////////////////////////LÄGGA TILL BOK////////////////////////////////////
            addBook.addEventListener("click", function() {
                fetch(`https://www.forverkliga.se/JavaScript/api/crud.php?op=insert&key=${inputKey.value}&title=${title.value}&author=${author.value}`)
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(json) {
                        console.log(json.status);
                        let addLi = document.createElement("li");
                        addLi.innerHTML += `Title: <strong>${title.value}</strong><br>`;
                        addLi.innerHTML += `Author: <strong>${author.value}</strong><br>`;
                        addLi.innerHTML += `Book ID: <strong>${json.id}</strong><br>`;
                        addLi.innerHTML += `Last Update: <strong>${datumet}</strong><br><br>`;
                        addLi.setAttribute("id", title.value)
                        if (json.status === "error") {
                            failAddCounter = failAddCounter + 1;
                            addBookStatus.innerHTML = `Status: <strong>${json.status}, try again!</strong><br>
                    Fail counter: <strong>${failAddCounter}</strong>`
                        } else {
                            addBookStatus.innerHTML = `Status: <strong>${json.status}</strong><br>
                    Book ID: <strong>${json.id}</strong>`
                            ulList[0].appendChild(addLi);
                        }
                    })
            });

            //////////////////////////////KOLLA BOKLISTAN////////////////////////////////////
            viewBooks.addEventListener("click", function(e) {
                ajaxAdd.onreadystatechange = function() {
                    ulList[0].innerHTML = "";
                    if (ajaxAdd.readyState === 4) {
                        let json = JSON.parse(ajaxAdd.responseText);
                        objBooks = json;
                        if (json.data !== undefined) {
                            for (let i = 0; i < json.data.length; i++) {
                                let addLi = document.createElement("li");
                                addLi.innerHTML += `Title: <strong>${json.data[i].title}</strong><br>`;
                                addLi.innerHTML += `Author: <strong>${json.data[i].author}</strong><br>`;
                                addLi.innerHTML += `Book ID: <strong class="idvalue">${json.data[i].id}</strong><br>`;
                                addLi.innerHTML += `Last Update: <strong>${json.data[i].updated}</strong><br><br>`;
                                addLi.setAttribute("id", json.data[i].title)
                                ulList[0].appendChild(addLi);
                            }
                        } else {
                            failViewCounter = failViewCounter + 1;
                            let addLi = document.createElement("li");
                            addLi.innerHTML += `Status: <strong>${json.message}</strong> <br> Fail counter: <strong>${failViewCounter}</strong>`;
                            ulList[0].appendChild(addLi);
                        }
                    }
                }
                ajaxAdd.open("get", `https://www.forverkliga.se/JavaScript/api/crud.php?op=select&key=${inputKey.value}`)
                ajaxAdd.send()

            });

            //////////////////////////////ÄNDRA I BOK////////////////////////////////////

            titleChange.addEventListener("change", function(event) {
                ajaxAdd.onreadystatechange = function() {
                    if (ajaxAdd.readyState === 4) {
                        let json = JSON.parse(ajaxAdd.responseText);
                        if (json.message === undefined) {
                            changeBookStatus.innerHTML = `Status: <strong>${json.status}</strong><br> Message: <strong>It worked!</strong>`;
                        } else {
                            changeBookStatus.innerHTML = `Status: <strong>${json.status}</strong> <br> Message: <strong>${json.message}</strong>`;
                            failChangeCounter = failChangeCounter + 1;
                            changeBookStatus.innerHTML = `Status: <strong>${json.status}, try again!</strong> <br>Fail counter: <strong>${failChangeCounter}</strong>`
                        }
                    }
                }
                ajaxAdd.open("get", `https://www.forverkliga.se/JavaScript/api/crud.php?op=update&key=${inputKey.value}&id=${bookId.value}&title=${titleChange.value}&author=${authorChange.value}`);
                ajaxAdd.send();
            });

            authorChange.addEventListener("change", function(event) {
                ajaxAdd.onreadystatechange = function() {
                    if (ajaxAdd.readyState === 4) {
                        let json = JSON.parse(ajaxAdd.responseText);
                        if (json.message === undefined) {
                            changeBookStatus.innerHTML = `Status: <strong>${json.status}</strong><br> Message: <strong>It worked!</strong>`;
                        } else {
                            changeBookStatus.innerHTML = `Status: <strong>${json.status}</strong> <br> Message: <strong>${json.message}</strong>`;
                            failChangeCounter = failChangeCounter + 1;
                            changeBookStatus.innerHTML = `Status: <strong>${json.status}, try again!</strong> <br>Fail counter: <strong>${failChangeCounter}</strong>`
                        }
                    }
                }
                ajaxAdd.open("get", `https://www.forverkliga.se/JavaScript/api/crud.php?op=update&key=${inputKey.value}&id=${bookId.value}&title=${titleChange.value}&author=${authorChange.value}`);
                ajaxAdd.send();
            });

            //////////////////////////////HÄMTA NYCKEL////////////////////////////////////

            btn.addEventListener("click", function(e) { // KLICKA PÅ KNAPP GET KEY
                ajaxAdd.onreadystatechange = function() {
                    if (ajaxAdd.readyState === 4) {
                        let json = JSON.parse(ajaxAdd.responseText);
                        inputKey.value = json.key
                    }
                }
                ajaxAdd.open("get", "https://www.forverkliga.se/JavaScript/api/crud.php?requestKey")
                ajaxAdd.send()
            });

            //////////////////////////////TA BORT BOK////////////////////////////////////
            deleteBook.addEventListener("click", function(event) {
                //console.log("Delete id value "+deleteId.value);
                ajaxAdd.onreadystatechange = function() {
                    if (ajaxAdd.readyState === 4) {
                        let json = JSON.parse(ajaxAdd.responseText);
//                        console.log(json)
                        let idVal = Number(deleteId.value)
                        for (let i = 0; i < objBooks.data.length; i++) {
                            if (objBooks.data[i].id === idVal) {
                                let id = document.getElementById(objBooks.data[i].title);
                                if (id !== null) {
                                    id.remove();
                                    console.log(objBooks.data[i].title)
                                    delBookStatus.innerHTML = `Status: <strong>Success!</strong>`
                                }
                            } else {
                                console.log(json)
                                failDelCounter = failDelCounter + 1;
                                delBookStatus.innerHTML = `Status: <strong>${json.status}</strong><br>
                                                            Message: <strong>${json.message}</strong>`;
                            }
                        }
                    }
                }
                ajaxAdd.open("get", "https://www.forverkliga.se/JavaScript/api/crud.php?op=delete&key=" + inputKey.value + "&id=" + deleteId.value)
                ajaxAdd.send()
            })
        })

    </script>

    <style>
        #key,
        #keyin {
            display: none;
        }

        body {
            font-family: monospace;
        }

        button {
            padding: 10px;
            color: white;
            margin: 10px;
            box-shadow: 5px 5px 10px;
            background: #b95c69;
            font-family: monospace;
        }

        input {
            padding: 5px;
            font-family: monospace;
            margin: 5px;
        }

        ul {
            background: rgb(159, 159, 159);
            width: 300px;
            height: 350px;
            box-shadow: 2px 2px 5px black;
            overflow: scroll;
            padding: 5px;
        }

    </style>
</head>

<body>

    <button id="key">Get Key</button>
    <br>
    <input type="text" placeholder="Key" name="" value="T8T4f" id="keyin"> <br>
    <input type="text" placeholder="Title" name="" id="title"><br>
    <input type="text" placeholder="Author" name="" id="author"><br>

    <button id="addBook">Add Book</button>
    <div id="addBookStatus">Status: <br>Book ID:</div>

    <input type="text" placeholder="Search after a book" name="" id="searchBook"><br>
    <button id="searchBookBtn">Search Book!</button>
    <button id="addBkn">Add searched book</button>
    <div id="addNewBookStatus">Status:<br>Book ID:</div>

    <ul>
    </ul>

    <button id="viewBooks">View Books</button><br>

    <input type="text" placeholder="Id" name="" id="bookId"> <br>
    <input type="text" placeholder="Title" name="" id="titleChange"><br>
    <input type="text" placeholder="Author" name="" id="authorChange"><br>
    <div id="changeBookStatus">Status:<br>Message:</div>


    <input type="text" placeholder="Delete Id" id="deleteId"><br>
    <button id="deleteBook">Delete Book</button><br>
    <div id="delBookStatus">Status output:</div>

    <br>

    <!--
    <ul>
    </ul>
-->
    <script src="externalApi.js" charset="utf-8"></script>

</body>

</html>
