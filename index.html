<!--T8T4f-->
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>LAB 4 Robin o Jonathan</title>

    <script>
        window.addEventListener("load", function() {

            let ajaxKey = new XMLHttpRequest(); // NEW AJAX REQUEST

            let btn = document.getElementById("key"); //HÄMTA GET KEY KNAPPEN

            let output = document.getElementById("output")
            let inputKey = document.getElementById("keyin");

            //Lägga till bok
            let ajaxAdd = new XMLHttpRequest(); // NEW AJAX REQUEST (EJ NÖDVÄNDIG)
            let addBook = document.getElementById("addBook");
            let title = document.getElementById("title");
            let author = document.getElementById("author");
            let addBookStatus = document.getElementById("addBookStatus");
            //Ändra bok
            let changeBookStatus = document.getElementById("changeBookStatus");
            let changeBook = document.getElementById("changeBook");
            let bookId = document.getElementById("bookId");
            let authorChange = document.getElementById("authorChange");
            let titleChange = document.getElementById("titleChange");
            //Ta bort Book
            let deleteBook = document.getElementById("deleteBook");
            let deleteId = document.getElementById("deleteId");

            //Kolla på böcker
            let viewBooks = document.getElementById("viewBooks");
            let ulList = document.getElementsByTagName("ul");



            let objBooks = ""

            addBook.addEventListener("click", function() {
                ajaxAdd.onreadystatechange = function() {
                    if (ajaxAdd.readyState === 4) {
                        let json = JSON.parse(ajaxAdd.responseText);
                        console.log(json)
                        console.log(ajaxAdd.id);
                        console.log(ajaxAdd.status);
                        console.log(inputKey.value)
                        console.log(title.value)
                        console.log(author.value)

                        addBookStatus.innerHTML = `Status: ${json.status}<br>
                    Book ID: ${json.id}`
                    }
                };
                ajaxAdd.open("get", `https://www.forverkliga.se/JavaScript/api/crud.php?op=insert&key=${inputKey.value}&title=${title.value}&author=${author.value}`)
                ajaxAdd.send();
            });


            //KOLLA LISTAN - TWEAK NEEDED!!

            viewBooks.addEventListener("click", function(e) {

                ajaxAdd.onreadystatechange = function() {
   ulList[0].innerHTML = "";
                    if (ajaxAdd.readyState === 4) {
                        let json = JSON.parse(ajaxAdd.responseText);

                      objBooks = json;


                      if(json.data.length !== undefined){
                        for(let i=0; i< json.data.length; i++){

                          let addLi = document.createElement("li");

                            addLi.innerHTML += `Title: <strong>${json.data[y].title}</strong><br>`;
                            addLi.innerHTML += `Author: <strong>${json.data[y].author}</strong><br>`;
                            addLi.innerHTML += `Book ID: <strong>${json.data[y].id}</strong><br>`;
                            addLi.innerHTML += `Last Update: <strong>${json.data[y].updated}</strong><br><br>`;
                            addLi.setAttribute("id", json.data[y].title)
                            ulList[0].appendChild(addLi);
                          }
                        }
                    }
                }
                ajaxAdd.open("get", `https://www.forverkliga.se/JavaScript/api/crud.php?op=select&key=${inputKey.value}`)
                ajaxAdd.send()

            });

            //////////////////////////////CHANGEBOOK////////////////////////////////////

            changeBook.addEventListener("click", function(event) {

                ajaxAdd.onreadystatechange = function() {
                    if (ajaxAdd.readyState === 4) {
                        let json = JSON.parse(ajaxAdd.responseText);
                        if (json.message === undefined) {
                            changeBookStatus.innerHTML = `Status: <strong>${json.status}</strong>`;
                        } else {
                            changeBookStatus.innerHTML = `Status: <strong>${json.status}</strong> <br> Message: <strong>${json.message}</strong>`;
                        }
                    }
                }
                ajaxAdd.open("get", `https://www.forverkliga.se/JavaScript/api/crud.php?op=update&key=${inputKey.value}&id=${bookId.value}&title=${titleChange.value}&author=${authorChange.value}`);
                ajaxAdd.send();
                    })


            /////////////////////////////////////////////////////////////////



            btn.addEventListener("click", function(e) { // KLICKA PÅ KNAPP GET KEY
                ajaxKey.onreadystatechange = function() {
                    if (ajaxKey.readyState === 4) {
                        let json = JSON.parse(ajaxKey.responseText);
                        inputKey.value = json.key
                    }
                }
                ajaxKey.open("get", "https://www.forverkliga.se/JavaScript/api/crud.php?requestKey")
                ajaxKey.send()
            });

            // DELETE Book
            deleteBook.addEventListener("click",function(event){

            // for(let i=0; i< objBooks.data.length;i++){
            //    // console.log("Delete id value " +deleteId.value)
            //    // console.log("Alla böckers id" + objBooks.data[i].id)
            //    if(objBooks.data[i].id === deleteId.value ){
            //       console.log("hej")
            //      //  console.log(deleteId.value)
            //   }
            // }


              ajaxKey.onreadystatechange = function(){

                if(ajaxKey.readyState === 4){
                  let json = JSON.parse(ajaxKey.responseText);

                      //console.log("Delete id value "+deleteId.value);
                    let idVal = Number(deleteId.value)

                      for(let i=0; i< objBooks.data.length;i++){

                         if(objBooks.data[i].id === idVal ){
                           let id = document.getElementById(objBooks.data[i].title);
                           id.remove()
                            console.log(objBooks.data[i].title)

                           //  console.log(deleteId.value)
                        }
                      }

                //   for(let i=0; i< json.data.length; i++ )
                //   console.log(json.data[i].id)
                 }
              }


              ajaxKey.open("get", "https://www.forverkliga.se/JavaScript/api/crud.php?op=delete&key="+inputKey.value+"&id="+deleteId.value)
              ajaxKey.send()
            });

        })

    </script>

    <style>
        body {}

        button {
            padding: 10px;
            color: white;
            margin: 10px;
            box-shadow: 5px 5px 10px;
            background: #b95c69;
        }

        input {
            padding: 5px;
            font-family: arial;
            margin: 5px;
        }

        ul {
            background: rgb(159, 159, 159);
            width: 250px;
            height: 300px;
            box-shadow: 2px 2px 5px black;
            overflow:scroll;
        }

    </style>
</head>

<body>

    <button id="key">Get Key</button>
    <br>
    <input type="text" placeholder="Key" name="" value="T8T4f" id="keyin"> <br>
    <input type="text" placeholder="Title" name="" id="title"><br>
    <input type="text" placeholder="Author" name="" id="author"><br>

    <button id="addBook">Add Book</button>
    <div id="addBookStatus"></div>

    <ul>
    </ul>

    <button id="viewBooks">View Books</button>
    <button id="changeBook">Change Book</button><br>
    <input type="text" placeholder="Id" name="" id="bookId"> <br>
    <input type="text" placeholder="Title" name="" id="titleChange"><br>
    <input type="text" placeholder="Author" name="" id="authorChange"><br>
    <div id="changeBookStatus"></div>

    <button id="deleteBook">Delete Book</button><br>
    <input type="text" placeholder="Delete Id" id="deleteId">


</body>

</html>
